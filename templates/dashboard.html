{% extends "base.html" %}

{% block title %}Dashboard - WorkLog{% endblock %}

{% block content %}
<div class="container">

    <h2>Welcome, {{ user.username }}</h2>
    <p>Role: {{ user_role }}</p>

    <hr>

    <!-- ================== ADD LOG ================== -->
    <h3>Add Timesheet Log</h3>
    <form method="POST" action="{{ url_for('dashboard') }}" class="mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <label>Date:</label>
                <input type="date" name="work_date" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label>Clock In:</label>
                <input type="time" name="clock_in" class="form-control" required>
            </div>
            <div class="col-md-3">
                <label>Clock Out:</label>
                <input type="time" name="clock_out" class="form-control" required>
            </div>
        </div>

        <div class="mt-3">
            <label>Task Description:</label>
            <textarea name="task_description" rows="3" class="form-control" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Add Log</button>
    </form>

    <!-- ================== PERSONAL LOGS ================== -->
    <h3>Your Logs</h3>

    {% if logs %}
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Clock In</th>
                    <th>Clock Out</th>
                    <th>Duration</th>
                    <th>Task</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.work_date }}</td>
                    <td>{{ log.clock_in }}</td>
                    <td>{{ log.clock_out }}</td>
                    <td>{{ log.workhour }}</td>
                    <td>{{ log.task_description }}</td>
                    <td>
                        <!-- EDIT -->
                        <button type="button" class="btn btn-sm btn-warning mb-1"
                            onclick="document.getElementById('edit-{{ log.id }}').style.display='block'">
                            Edit
                        </button>

                        <div id="edit-{{ log.id }}" style="display:none; margin-top:10px;">
                            <form method="POST" action="{{ url_for('update_log', log_id=log.id) }}">
                                <input type="date" name="date" value="{{ log.work_date }}" class="form-control mb-1" required>
                                <input type="time" name="clock_in" value="{{ log.clock_in }}" class="form-control mb-1" required>
                                <input type="time" name="clock_out" value="{{ log.clock_out }}" class="form-control mb-1" required>
                                <textarea name="task_description" class="form-control mb-1" required>{{ log.task_description }}</textarea>
                                <button type="submit" class="btn btn-success btn-sm">Save</button>
                                <button type="button" class="btn btn-secondary btn-sm"
                                    onclick="document.getElementById('edit-{{ log.id }}').style.display='none'">Cancel</button>
                            </form>
                        </div>

                        <!-- DELETE -->
                        <form method="POST" action="{{ url_for('delete_log', log_id=log.id) }}" class="d-inline"
                            onsubmit="return confirm('Are you sure?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No logs found.</p>
    {% endif %}

    <hr>

    <!-- ================== SENIOR / ADMIN ================== -->
    {% if user_role in ['senior', 'admin'] %}
    <h3>View User Logs</h3>
    <form method="POST" action="{{ url_for('dashboard') }}" class="mb-3">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label>Select User:</label>
                <select name="user_id" class="form-select" required>
                    <option value="">-- Select --</option>
                    {% for u in users %}
                    <option value="{{ u.id }}">{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary">View Logs</button>
            </div>
        </div>
    </form>

    {% if selected_user_logs %}
    <h4>Time sheet of {{ selected_user_name }}</h4>
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Clock In</th>
                    <th>Clock Out</th>
                    <th>Duration</th>
                    <th>Task</th>
                    <!-- <th>Actions</th> -->
                </tr>
            </thead>
            <tbody>
                {% for log in selected_user_logs %}
                <tr>
                    <td>{{ log.work_date }}</td>
                    <td>{{ log.clock_in }}</td>
                    <td>{{ log.clock_out }}</td>
                    <td>{{ log.workhour }}</td>
                    <td>{{ log.task_description }}</td>
                    <!-- <td>
                        <button type="button" class="btn btn-sm btn-warning mb-1"
                            onclick="document.getElementById('edit-admin-{{ log.id }}').style.display='block'">
                            Edit
                        </button>

                        <div id="edit-admin-{{ log.id }}" style="display:none; margin-top:10px;">
                            <form method="POST" action="{{ url_for('update_log', log_id=log.id) }}">
                                <input type="date" name="date" value="{{ log.work_date }}" class="form-control mb-1" required>
                                <input type="time" name="clock_in" value="{{ log.clock_in }}" class="form-control mb-1" required>
                                <input type="time" name="clock_out" value="{{ log.clock_out }}" class="form-control mb-1" required>
                                <textarea name="task_description" class="form-control mb-1" required>{{ log.task_description }}</textarea>
                                <button type="submit" class="btn btn-success btn-sm">Save</button>
                            </form>
                        </div>

                        <form method="POST" action="{{ url_for('delete_log', log_id=log.id) }}" class="d-inline"
                            onsubmit="return confirm('Are you sure?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td> -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    {% endif %}

</div>
{% endblock %}
